#!/usr/bin/env bash
set -euo pipefail

# apply_changes_locally.sh
# Run this in the repository root (Windows/MSYS2 bash) to write the updated files,
# backing up original files with .orig suffix.
# Usage: bash apply_changes_locally.sh

ROOT="$(pwd)"
backup() {
  local f="$1"
  if [ -f "$f" ] && [ ! -f "$f.orig" ]; then
    echo "Backing up $f -> $f.orig"
    cp -a "$f" "$f.orig"
  fi
}

write() {
  local fpath="$1"
  local marker="$2"
  local content="$3"
  mkdir -p "$(dirname "$fpath")"
  backup "$fpath"
  cat > "$fpath" <<'EOF'
${content}
EOF
  echo "Wrote $fpath"
}

# Files to write (contents inserted below)

# .vscode/tasks.json
write "$ROOT/.vscode/tasks.json" "TASKS_JSON" $'{\n  "version": "2.0.0",\n  "tasks": [\n    {\n      "label": "build all",\n      "type": "shell",\n      "command": "bash",\n      "args": [\n        "-lc",\n        "mkdir -p \"${workspaceFolder}/output\" && for src in \"${workspaceFolder}\"/*.c; do exe=\"${workspaceFolder}/output/$(basename \"$src\" .c).exe\"; echo Compiling $src -> $exe; gcc -Wall -Wextra -g3 \"$src\" -o \"$exe\" || exit 1; done && ./.vscode/scripts/copy_sdl_dlls.sh"\n      ],\n      "options": { "cwd": "${workspaceFolder}", "env": { "LANG": "zh_CN.UTF-8", "LC_ALL": "zh_CN.UTF-8", "MSYS_UTF8": "1" } },\n      "group": { "kind": "build", "isDefault": true },\n      "problemMatcher": ["$gcc"]\n    },\n\n    {\n      "label": "build sdl",\n      "type": "shell",\n      "command": "bash",\n      "args": [\n        "-lc",\n        "mkdir -p \"${workspaceFolder}/output\" && echo Building SDL app... && gcc -Wall -Wextra -g3 \"${workspaceFolder}/main.c\" -o \"${workspaceFolder}/output/main_sdl.exe\" $(pkg-config --cflags --libs sdl2 SDL2_image SDL2_mixer) && ./.vscode/scripts/copy_sdl_dlls.sh"\n      ],\n      "options": { "cwd": "${workspaceFolder}", "env": { "LANG": "zh_CN.UTF-8", "LC_ALL": "zh_CN.UTF-8", "MSYS_UTF8": "1" } },\n      "problemMatcher": ["$gcc"]\n    },\n\n    {\n      "label": "copy sdl dlls",\n      "type": "shell",\n      "command": "bash",\n      "args": ["-lc", "./.vscode/scripts/copy_sdl_dlls.sh"],\n      "options": { "cwd": "${workspaceFolder}", "env": { "LANG": "zh_CN.UTF-8", "LC_ALL": "zh_CN.UTF-8", "MSYS_UTF8": "1" } }\n    },\n\n    {\n      "label": "build current file",\n      "type": "shell",\n      "command": "bash",\n      "args": ["-lc", "./.vscode/scripts/build_current_file.sh \"${file}\""],\n      "options": { "cwd": "${workspaceFolder}", "env": { "LANG": "zh_CN.UTF-8", "LC_ALL": "zh_CN.UTF-8", "MSYS_UTF8": "1" } },\n      "presentation": { "echo": true, "reveal": "always", "focus": true, "panel": "shared" },\n      "problemMatcher": ["$gcc"]\n    },\n\n    {\n      "label": "build sdl win",\n      "type": "shell",\n      "command": "bash",\n      "args": [\n        "-lc",\n        "mkdir -p \"${workspaceFolder}/output\" && echo Building SDL (explicit paths)... && gcc -Wall -Wextra -g3 \"${workspaceFolder}/main_sdl.c\" -I\"C:/msys64/mingw64/include/SDL2\" -L\"C:/msys64/mingw64/lib\" -o \"${workspaceFolder}/output/main_sdl_win.exe\" -lmingw32 -lSDL2main -lSDL2 -lSDL2_image -lSDL2_mixer -logg -lvorbis -lopus -lpng16 -ljpeg && ./.vscode/scripts/copy_sdl_dlls.sh"\n      ],\n      "options": { "cwd": "${workspaceFolder}", "env": { "LANG": "zh_CN.UTF-8", "LC_ALL": "zh_CN.UTF-8", "MSYS_UTF8": "1" } },\n      "problemMatcher": ["$gcc"]\n    }\n  ]\n}\n'}

# .vscode/launch.json
write "$ROOT/.vscode/launch.json" "LAUNCH_JSON" $'{\n  "version": "0.2.0",\n  "configurations": [\n    {\n      "name": "Run main.exe (Compile then Run, No Debug)",\n      "type": "cppvsdbg",\n      "request": "launch",\n      "program": "${workspaceFolder}/output/main.exe",\n      "args": [],\n      "stopAtEntry": false,\n      "cwd": "${workspaceFolder}",\n      "environment": [\n        { "name": "LANG", "value": "zh_CN.UTF-8" },\n        { "name": "LC_ALL", "value": "zh_CN.UTF-8" },\n        { "name": "MSYS_UTF8", "value": "1" }\n      ],\n      "externalConsole": true,\n      "preLaunchTask": "build all"\n    },\n    {\n      "name": "Run test.exe (Compile then Run, No Debug)",\n      "type": "cppvsdbg",\n      "request": "launch",\n      "program": "${workspaceFolder}/output/test.exe",\n      "args": [],\n      "stopAtEntry": false,\n      "cwd": "${workspaceFolder}",\n      "environment": [\n        { "name": "LANG", "value": "zh_CN.UTF-8" },\n        { "name": "LC_ALL", "value": "zh_CN.UTF-8" },\n        { "name": "MSYS_UTF8", "value": "1" }\n      ],\n      "externalConsole": true,\n      "preLaunchTask": "build all"\n    },\n    {\n      "name": "Run learning.exe (Compile then Run, No Debug)",\n      "type": "cppvsdbg",\n      "request": "launch",\n      "program": "${workspaceFolder}/output/learning.exe",\n      "args": [],\n      "stopAtEntry": false,\n      "cwd": "${workspaceFolder}",\n      "environment": [\n        { "name": "LANG", "value": "zh_CN.UTF-8" },\n        { "name": "LC_ALL", "value": "zh_CN.UTF-8" },\n        { "name": "MSYS_UTF8", "value": "1" }\n      ],\n      "externalConsole": true,\n      "preLaunchTask": "build all"\n    },\n    {\n      "name": "Run main_sdl.exe (Build SDL then Run)",\n      "type": "cppvsdbg",\n      "request": "launch",\n      "program": "${workspaceFolder}/output/main_sdl.exe",\n      "args": [],\n      "stopAtEntry": false,\n      "cwd": "${workspaceFolder}",\n      "environment": [\n        { "name": "LANG", "value": "zh_CN.UTF-8" },\n        { "name": "LC_ALL", "value": "zh_CN.UTF-8" },\n        { "name": "MSYS_UTF8", "value": "1" }\n      ],\n      "externalConsole": true,\n      "preLaunchTask": "build sdl"\n    },\n    {\n      "name": "Run main_sdl_win.exe (Build SDL win then Run)",\n      "type": "cppvsdbg",\n      "request": "launch",\n      "program": "${workspaceFolder}/output/main_sdl_win.exe",\n      "args": [],\n      "stopAtEntry": false,\n      "cwd": "${workspaceFolder}",\n      "environment": [\n        { "name": "LANG", "value": "zh_CN.UTF-8" },\n        { "name": "LC_ALL", "value": "zh_CN.UTF-8" },\n        { "name": "MSYS_UTF8", "value": "1" }\n      ],\n      "externalConsole": true,\n      "preLaunchTask": "build sdl win"\n    },\n    {\n      "name": "Run Current C File (Build then Run)",\n      "type": "cppvsdbg",\n      "request": "launch",\n      "program": "${workspaceFolder}/output/${fileBasenameNoExtension}.exe",\n      "args": [],\n      "stopAtEntry": false,\n      "cwd": "${workspaceFolder}",\n      "environment": [\n        { "name": "LANG", "value": "zh_CN.UTF-8" },\n        { "name": "LC_ALL", "value": "zh_CN.UTF-8" },\n        { "name": "MSYS_UTF8", "value": "1" }\n      ],\n      "externalConsole": true,\n      "preLaunchTask": "build current file"\n    },\n    {\n      "name": "C/C++ Runner: Debug Session",\n      "type": "cppdbg",\n      "request": "launch",\n      "program": "${workspaceFolder}/output/main.exe",\n      "args": [],\n      "stopAtEntry": false,\n      "cwd": "${workspaceFolder}",\n      "environment": [\n        { "name": "LANG", "value": "zh_CN.UTF-8" },\n        { "name": "LC_ALL", "value": "zh_CN.UTF-8" },\n        { "name": "MSYS_UTF8", "value": "1" }\n      ],\n      "externalConsole": true\n    }\n  ]\n}\n'}

# .vscode/settings.json
write "$ROOT/.vscode/settings.json" "SETTINGS_JSON" $'{\n  "files.encoding": "utf8",\n  "files.autoGuessEncoding": true,\n  "files.eol": "\\n",\n  "terminal.integrated.env.windows": {\n    "LANG": "zh_CN.UTF-8",\n    "LC_ALL": "zh_CN.UTF-8",\n    "MSYS_UTF8": "1"\n  },\n  "C_Cpp_Runner.cCompilerPath": "gcc",\n  "C_Cpp_Runner.cppCompilerPath": "g++",\n  "C_Cpp_Runner.debuggerPath": "",\n  "C_Cpp_Runner.generateLaunch": false,\n  "C_Cpp_Runner.autoGenerateLaunch": false,\n  "C_Cpp_Runner.cStandard": "",\n  "C_Cpp_Runner.cppStandard": "",\n  "C_Cpp_Runner.msvcBatchPath": "C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Auxiliary/Build/vcvarsall.bat",\n  "C_Cpp_Runner.useMsvc": false,\n  "C_Cpp_Runner.warnings": [\n    "-Wall",\n    "-Wextra",\n    "-Wpedantic",\n    "-Wshadow",\n    "-Wformat=2",\n    "-Wcast-align",\n    "-Wconversion",\n    "-Wsign-conversion",\n    "-Wnull-dereference"\n  ],\n  "C_Cpp_Runner.msvcWarnings": [\n    "/W4",\n    "/permissive-",\n    "/w14242",\n    "/w14287",\n    "/w14296",\n    "/w14311",\n    "/w14826",\n    "/w44062",\n    "/w44242",\n    "/w14905",\n    "/w14906",\n    "/w14263",\n    "/w44265",\n    "/w14928"\n  ],\n  "C_Cpp_Runner.enableWarnings": true,\n  "C_Cpp_Runner.warningsAsError": false,\n  "C_Cpp_Runner.compilerArgs": [],\n  "C_Cpp_Runner.linkerArgs": [],\n  "C_Cpp_Runner.includePaths": [],\n  "C_Cpp_Runner.includeSearch": [\n    "*",\n    "**/*"\n  ],\n  "C_Cpp_Runner.excludeSearch": [\n    "**/build",\n    "**/build/**",\n    "**/.*",\n    "**/.*/**",\n    "**/.vscode",\n    "**/.vscode/**"\n  ],\n  "C_Cpp_Runner.useAddressSanitizer": false,\n  "C_Cpp_Runner.useUndefinedSanitizer": false,\n  "C_Cpp_Runner.useLeakSanitizer": false,\n  "C_Cpp_Runner.showCompilationTime": false,\n  "C_Cpp_Runner.useLinkTimeOptimization": false,\n  "C_Cpp_Runner.msvcSecureNoWarnings": false\n}\n'}

# .vscode/scripts/build_current_file.sh
write "$ROOT/.vscode/scripts/build_current_file.sh" "BUILD_SCRIPT" $'#!/usr/bin/env bash\nset -euo pipefail\n\n# Ensure UTF-8 environment for MSYS2/MinGW shells\nexport LANG="zh_CN.UTF-8"\nexport LC_ALL="zh_CN.UTF-8"\nexport MSYS_UTF8=1\n\n# Usage: build_current_file.sh [path/to/file.c]\n# If an argument is provided and exists, build it. Otherwise present a selection menu for .c files in the workspace.\n\nWORKSPACE_DIR="${PWD}"\nARG_FILE="${1-}" \n\nchoose_file() {\n  # Build an array of .c files\n  mapfile -t allfiles < <(printf "%s\\n" "$WORKSPACE_DIR"/*.c)\n  filtered=()\n  for f in "${allfiles[@]}"; do\n    [ -f "$f" ] || continue\n    filtered+=("$f")\n  done\n  if [ ${#filtered[@]} -eq 0 ]; then\n    echo "No .c files found in ${WORKSPACE_DIR}" >&2\n    exit 1\n  fi\n\n  # Present a numbered menu and read from the real terminal (/dev/tty) so input echoes correctly\n  echo "Select a C file to build:"\n  for i in "${!filtered[@]}"; do\n    printf "%3d) %s\\n" $((i+1)) "${filtered[$i]}"\n  done\n  while true; do\n    if ! read -r -p "Enter number (or Ctrl-C to cancel): " choice </dev/tty; then\n      echo "Selection cancelled" >&2\n      exit 1\n    fi\n    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le ${#filtered[@]} ]; then\n      idx=$((choice-1))\n      echo "${filtered[$idx]}"\n      return 0\n    fi\n    echo "Invalid selection" >&2\n  done\n}\n\nif [ -n "$ARG_FILE" ] && [ -f "$ARG_FILE" ]; then\n  SOURCE="$ARG_FILE"\nelse\n  # If running non-interactively (no TTY), pick the first .c file automatically.\n  if [ ! -t 0 ]; then\n    for f in "$WORKSPACE_DIR"/*.c; do\n      if [ -f "$f" ]; then\n        SOURCE="$f"\n        break\n      fi\n    done\n    if [ -z "${SOURCE-}" ]; then\n      echo "No .c files found in ${WORKSPACE_DIR}" >&2\n      exit 1\n    fi\n  else\n    SOURCE=$(choose_file)\n  fi\nfi\n\nbasename_no_ext=$(basename "$SOURCE" .c)\nout="$WORKSPACE_DIR/output/${basename_no_ext}.exe"\nmkdir -p "$(dirname "$out")"\necho "Compiling $SOURCE -> $out"\ngcc -Wall -Wextra -g3 "$SOURCE" -o "$out"\nrc=$?\nif [ $rc -ne 0 ]; then\n  echo "Compilation failed with exit code $rc" >&2\n  exit $rc\nfi\necho "Built: $out"\n# write a small marker file so other tools can verify which source produced this exe\necho "$SOURCE" > "$out.built_from"\ndate -u +"%Y-%m-%dT%H:%M:%SZ" > "$out.built_at"\n\nexit 0\n'

# .vscode/scripts/copy_sdl_dlls.sh
write "$ROOT/.vscode/scripts/copy_sdl_dlls.sh" "COPY_SCRIPT" $'#!/usr/bin/env bash\nset -euo pipefail\n \n# Ensure UTF-8 environment for MSYS2/MinGW shells\nexport LANG="zh_CN.UTF-8"\nexport LC_ALL="zh_CN.UTF-8"\nexport MSYS_UTF8=1\nmkdir -p "${PWD}/output"\n# List of patterns to copy; only copy if destination missing\npatterns=( "/mingw64/bin/SDL2*.dll" "/mingw64/bin/libSDL2_image*" "/mingw64/bin/libSDL2_mixer*" "/mingw64/bin/libopus*" "/mingw64/bin/libvorbis*" "/mingw64/bin/libogg*" "/mingw64/bin/libpng16-16.dll" "/mingw64/bin/libjpeg-*.dll" )\nfor p in "${patterns[@]}"; do\n  for f in $p; do\n    [ -e "$f" ] || continue\n    dest="${PWD}/output/$(basename "$f")"\n    if [ ! -e "$dest" ]; then\n      cp -v "$f" "$dest"\n    else\n      echo "Skipping existing: $(basename "$f")"\n    fi\n  done\ndone\n'

# .vscode/scripts/run_built_exe.sh
write "$ROOT/.vscode/scripts/run_built_exe.sh" "RUN_SCRIPT" $'#!/usr/bin/env bash\nset -euo pipefail\n\n# Usage: run_built_exe.sh path/to/exe\n# Verifies .built_from marker (if present) and runs the exe in the current terminal.\n\nEXE_PATH="${1-}"\nif [ -z "$EXE_PATH" ]; then\n  echo "Usage: $0 path/to/exe" >&2\n  exit 2\nfi\nif [ ! -f "$EXE_PATH" ]; then\n  echo "Executable not found: $EXE_PATH" >&2\n  exit 3\nfi\n\nif [ -f "$EXE_PATH.built_from" ]; then\n  src=$(cat "$EXE_PATH.built_from")\n  echo "Executable was built from: $src"\nelse\n  echo "No built_from marker for $EXE_PATH"\nfi\n\necho "Running: $EXE_PATH"\n"$EXE_PATH"\n'

# platform_console.h
write "$ROOT/platform_console.h" "PLAT_HDR" $'/* platform_console.h\n * Cross-platform console helpers\n */\n#ifndef PLATFORM_CONSOLE_H\n#define PLATFORM_CONSOLE_H\n\n#ifdef __cplusplus\nextern "C" {\n#endif\n\n/* Ensure console output uses UTF-8 on supported platforms. */\nvoid setConsoleOutputCPToUTF8(void);\n\n#ifdef __cplusplus\n}\n#endif\n\n#endif /* PLATFORM_CONSOLE_H */\n'

# platform_console.c
write "$ROOT/platform_console.c" "PLAT_C" $'/* platform_console.c\n * Cross-platform implementation for console encoding helpers.\n */\n#include "platform_console.h"\n\n#ifdef _WIN32\n#include <windows.h>\n#else\n#include <locale.h>\n#endif\n\nvoid setConsoleOutputCPToUTF8(void) {\n#ifdef _WIN32\n    /* Set output code page to UTF-8 on Windows */\n    SetConsoleOutputCP(CP_UTF8);\n    SetConsoleCP(CP_UTF8);\n#else\n    /* Use the user\'s locale settings on POSIX; UTF-8 is expected from environment */\n    setlocale(LC_ALL, "");\n#endif\n}\n'

# main.c (modified)
write "$ROOT/main.c" "MAIN_C" $'#include <stdio.h>\n#include <stdlib.h>\n#include <time.h>\n#include "platform_console.h"\n\n// 交换两个元素的值\nvoid swap(int* a, int* b) {\n    int temp = *a;\n    *a = *b;\n    *b = temp;\n}\n\n// 分区函数 - 使用最后一个元素作为基准\nint partition(int arr[], int low, int high) {\n    int pivot = arr[high];  // 选择最后一个元素作为基准\n    int i = (low - 1);      // 指向小于基准的区域的末尾\n    \n    for (int j = low; j <= high - 1; j++) {\n        // 如果当前元素小于或等于基准\n        if (arr[j] <= pivot) {\n            i++;  // 扩展小于基准的区域\n            swap(&arr[i], &arr[j]);\n        }\n    }\n    swap(&arr[i + 1], &arr[high]);  // 将基准放到正确位置\n    return (i + 1);\n}\n\n// 随机分区函数 - 避免最坏情况\nint randomPartition(int arr[], int low, int high) {\n    // 生成 low 到 high 之间的随机索引\n    int random = low + rand() % (high - low + 1);\n    // 将随机元素与最后一个元素交换\n    swap(&arr[random], &arr[high]);\n    return partition(arr, low, high);\n}\n\n// 快速排序主函数\nvoid quickSort(int arr[], int low, int high) {\n    if (low < high) {\n        // 获取分区点，基准元素已位于正确位置\n        int pi = randomPartition(arr, low, high);\n        \n        // 递归排序分区点左侧的元素\n        quickSort(arr, low, pi - 1);\n        // 递归排序分区点右侧的元素\n        quickSort(arr, pi + 1, high);\n    }\n}\n\n// 打印数组\nvoid printArray(int arr[], int size) {\n    for (int i = 0; i < size; i++) {\n        printf("%d ", arr[i]);\n    }\n    printf("\n");\n}\n\n// 测试代码\nint main() {\n\n    setConsoleOutputCPToUTF8();\n    // 初始化随机数种子\n    srand(time(NULL));\n    \n    int arr[] = {10, 7, 8, 9, 1, 5};\n    int n = sizeof(arr) / sizeof(arr[0]);\n    \n    printf("原始数组: ");\n    printArray(arr, n);\n    \n    quickSort(arr, 0, n - 1);\n    \n    printf("排序后的数组: ");\n    printArray(arr, n);\n    \n    // 测试更多例子\n    int arr2[] = {64, 34, 25, 12, 22, 11, 90};\n    int n2 = sizeof(arr2) / sizeof(arr2[0]);\n    \n    printf("\n另一个例子:\n");\n    printf("原始数组: ");\n    printArray(arr2, n2);\n    \n    quickSort(arr2, 0, n2 - 1);\n    \n    printf("排序后的数组: ");\n    printArray(arr2, n2);\n    \n    return 0;\n}\n'

# SDL_SETUP.md (partial update)
write "$ROOT/SDL_SETUP.md" "SDL_SETUP" $'````markdown\nSDL2 使用与构建说明 (MSYS2 / mingw64)\n\n概览\n- 你已在 `C:/msys64/mingw64` 安装好 SDL2，SDL2_image，SDL2_mixer，并已把运行时 DLL 放到项目的 `output/` 目录。\n- 仓库已添加测试程序 `main_sdl.c`，及若干 VS Code 任务来编译与复制 DLL：\n  - `build sdl`：使用 `pkg-config` 在 MSYS2 环境里编译 `main.c` -> `output/main_sdl.exe` 并复制常见 DLL。\n  - `build sdl win`：使用显式路径（`C:/msys64/mingw64`）编译 `main_sdl.c` -> `output/main_sdl_win.exe`，适用于在非 pkg-config 环境下的命令行或 PowerShell。\n  - `copy sdl dlls`：单独把 `/mingw64/bin` 的 SDL 相关 DLL 复制到 `output/`。\n\n如何在 MSYS2 (mingw64) 下验证（已测试）\n1. 打开 "MSYS2 MinGW 64-bit" shell。\n2. 在项目根运行：\n```bash\ngcc -Wall -Wextra -g3 main_sdl.c -o output/main_sdl.exe $(pkg-config --cflags --libs sdl2 SDL2_image SDL2_mixer)\n./output/main_sdl.exe\n```\n期望输出：\n```\nSDL, SDL_image and SDL_mixer initialized successfully.\n```\n\n在 Windows PowerShell / CMD 下的等效命令（不依赖 pkg-config）\n- 编译（PowerShell 或 CMD）：下面是更完整的显式链接命令，包含常见的运行时依赖库（ogg/vorbis/opus/png/jpeg）：\n```\ngcc -IC:/msys64/mingw64/include/SDL2 -LC:/msys64/mingw64/lib main_sdl.c -o output/main_sdl_win.exe -lmingw32 -lSDL2main -lSDL2 -lSDL2_image -lSDL2_mixer -logg -lvorbis -lopus -lpng16 -ljpeg\n```\n（这是仓库任务 `build sdl win` 中使用的完整链接行。）\n- 复制 DLL（PowerShell）：\n```powershell\nCopy-Item C:\\msys64\\mingw64\\bin\\SDL2.dll -Destination .\\output\\ -Verbose\nCopy-Item C:\\msys64\\mingw64\\bin\\SDL2_image.dll -Destination .\\output\\ -Verbose\nCopy-Item C:\\msys64\\mingw64\\bin\\SDL2_mixer.dll -Destination .\\output\\ -Verbose\n# 如需其它依赖 (libogg, libvorbis, libopus, libpng, libjpeg)，也一并复制\n```\n\nVS Code 中的使用（已加入任务与启动配置）\n- 直接用任务：Ctrl+Shift+P -> Tasks: Run Task -> 选择 `build sdl`（在 MSYS2 shell 环境下）或 `build sdl win`（显式路径编译）。\n- 若要运行调试/运行配置：选择 `Run main_sdl.exe (Build SDL then Run)`，VS Code 会先执行 `build sdl`，然后运行 `output/main_sdl.exe`。\n\n故障排查要点\n- 如果 `pkg-config` 报错找不到库，先在 MSYS2 MinGW64 下运行 `pkg-config --cflags --libs sdl2 SDL2_image SDL2_mixer` 看输出。\n- 链接错误时，尝试使用 `build sdl win` 的显式路径命令并检查 `C:/msys64/mingw64/lib` 下是否存在 `libSDL2.a` 或 `libSDL2.dll.a`。\n- 运行时报缺 DLL：把对应的 DLL（从 `C:/msys64/mingw64/bin`）复制到 `output/`。\n\n如果你希望我把 `build sdl win` 的链接选项扩展为包含所有可能的依赖库（libogg/libvorbis/libopus/libpng/libjpeg 等），我可以把命令改成更完整的一行并提交到 `tasks.json`。\n- 关于中文/UTF-8 编码 (已配置)\n- 工作区已启用 UTF-8：`.vscode/settings.json` 设置了 `files.encoding = utf8`，并为集成终端注入了 `LANG=zh_CN.UTF-8`、`LC_ALL=zh_CN.UTF-8` 和 `MSYS_UTF8=1`。这能让 MSYS2 / MinGW 的 bash 输出使用 UTF-8 编码，减少中文乱码。\n- 任务与调试配置也设置了相同的环境变量（`tasks.json` 与 `.vscode/launch.json` 的 `environment`），并且构建脚本在运行时会导出这些变量，保证 subprocess 使用 UTF-8。\n- 如果你仍在 Windows 外部控制台（PowerShell/CMD）中看到乱码，确保你的控制台使用 UTF-8 代码页：在 PowerShell 中运行 `chcp 65001`，或在程序中调用 `SetConsoleOutputCP(65001)`（仓库中已有 `setConsoleOutputCPToUTF8()` 建议函数）。\n\n平台控制台助手\n- 新增模块 `platform_console.h` / `platform_console.c`，包含 `setConsoleOutputCPToUTF8()` 的跨平台实现：\n  - 在 Windows 上调用 `SetConsoleOutputCP(CP_UTF8)` / `SetConsoleCP(CP_UTF8)`。\n  - 在 POSIX（Linux/macOS）上调用 `setlocale(LC_ALL, "")` 以使用环境定义的编码（通常设置为 UTF-8）。\n  - 代码示例：在你的 `main()` 开头调用 `setConsoleOutputCPToUTF8();` 来统一控制台编码行为。\n\n这使得代码在 Windows 下能正确设置控制台为 UTF-8，同时在其他平台也能优雅降级。\n'}

# Make the new scripts executable
chmod +x ./.vscode/scripts/*.sh || true

cat <<'EOF' >&2

Patch application complete. Files written to working tree and originals backed up with .orig suffix where present.
To commit locally:
  git checkout -b feat/platform-console
  git add -A
  git commit -m "feat: add platform_console and VS Code UTF-8/task improvements"

If you want, I can produce a smaller commit message or adjust files before you commit.
EOF

echo "Done."
